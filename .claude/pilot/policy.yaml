# yaml-language-server: $schema=./schemas/policy.schema.json
# Pilot AGI Governance Policy
# This file defines enforcement rules that control agent behavior.
# Hooks (session_start.js, user_prompt_submit.js, pre_tool_use.js) read this
# policy to enforce governance rules.
#
# POSITION: This is the definitive enterprise governance DSL for Claude Code.
# While Claude Code provides AI coding power, this policy ensures compliance.
#
# Version: 2.0
# Updated: 2026-01-25

version: "2.0"

# =============================================================================
# ENFORCEMENT RULES
# Controls what must be true before code edits are allowed
# =============================================================================
enforcement:
  # R1: Must have an active claimed task to edit files
  # When true, Edit/Write operations are blocked unless a bd task is claimed
  require_active_task: true

  # R2: Must have an approved plan for complex tasks
  # When true, blocks edits until plan is approved
  require_plan_approval: true

  # Plan approval threshold determines when plans are required:
  # - "low": Always require plan approval
  # - "medium": Require for tasks with 2+ steps (default)
  # - "high": Require only for tasks marked as complex
  plan_approval_threshold: "medium"

  # R3: Protected branches cannot be edited directly
  # Edit/Write blocked when on these branches
  protected_branches:
    - main
    - master
    - production

  # R4: Detect new scope in user messages (Semantic Guardian)
  # When true, user prompts are analyzed for new work requests
  # and routed to /pilot-new-task instead of direct implementation
  detect_new_scope: true

  # Keywords that trigger new scope detection
  new_scope_keywords:
    - "add feature"
    - "implement"
    - "create new"
    - "build"
    - "fix bug"
    - "add a"
    - "can you add"
    - "let's add"

# =============================================================================
# EXECUTION RULES
# Controls what must happen during and after each micro-step
# =============================================================================
execution:
  # R5: Run verification after each micro-step
  # Ensures changes work before moving to next step
  require_verification: true

  # R6: Create a commit after each micro-step
  # Keeps commits atomic and easy to review/revert
  require_commit_per_step: true

  # R7: Update session run log after each action
  # Maintains crash recovery context in runs/YYYY-MM-DD.md
  require_run_log_update: true

  # R8: Update bd task status after state changes
  # Keeps bd as the single source of truth for task state
  require_bd_update: true

# =============================================================================
# AUDIT TRAIL (Enterprise Compliance)
# Configures comprehensive logging for compliance audits
# =============================================================================
audit_trail:
  # Master switch for audit logging
  enabled: true

  # Log all tool uses (for SOC2, HIPAA compliance)
  log_tool_uses: true

  # Log format: "json" for machine parsing, "markdown" for humans
  format: "json"

  # Where to write audit logs
  log_file: "runs/audit.jsonl"

  # What to capture in each log entry
  capture:
    - timestamp
    - session_id
    - user_id
    - task_id
    - tool_name
    - tool_args_hash      # Hash of args (not full content for PII)
    - result_status       # success/failure
    - files_touched

  # Retention policy
  retention:
    days: 90
    archive_to: "runs/archive/"

  # Events that always get logged regardless of other settings
  always_log:
    - file_edit
    - file_delete
    - bash_command
    - plan_approval
    - task_claim
    - task_close

# =============================================================================
# APPROVAL MATRIX (Role-Based Access Control)
# Defines who can approve what types of changes
# =============================================================================
approval_matrix:
  # Default approval requirements
  defaults:
    # Can the AI auto-approve simple changes?
    ai_auto_approve: false
    # Require explicit human approval for all changes
    require_human: true

  # Change types and their approval requirements
  change_types:
    # Standard code changes - default approval
    code_change:
      ai_auto_approve: true
      require_human: false
      escalate_if:
        - files_changed > 10
        - touches_auth_code
        - touches_payment_code

    # Documentation changes - can be auto-approved
    documentation:
      ai_auto_approve: true
      require_human: false

    # Database migrations - always require human
    database_migration:
      ai_auto_approve: false
      require_human: true
      approvers:
        - tech_lead
        - dba
      notify:
        - ops_team

    # Authentication/authorization changes - critical
    auth_change:
      ai_auto_approve: false
      require_human: true
      approvers:
        - security_team
        - tech_lead
      notify:
        - security_team

    # File deletions - require confirmation
    file_deletion:
      ai_auto_approve: false
      require_human: true
      warn_message: "This action will delete files permanently."

    # External API integrations - review required
    external_api:
      ai_auto_approve: false
      require_human: true
      approvers:
        - tech_lead
      checklist:
        - "API key stored in secrets manager?"
        - "Rate limiting implemented?"
        - "Error handling complete?"

    # Production deployments - highest approval
    production_deploy:
      ai_auto_approve: false
      require_human: true
      require_multiple_approvers: true
      min_approvers: 2
      approvers:
        - tech_lead
        - ops_team
        - product_owner

  # Role definitions (map to actual users/groups externally)
  roles:
    tech_lead:
      can_approve: all
      can_override: true
    security_team:
      can_approve: [auth_change, production_deploy]
      can_override: false
    dba:
      can_approve: [database_migration]
      can_override: false
    ops_team:
      can_approve: [production_deploy]
      can_override: false
    product_owner:
      can_approve: [production_deploy]
      can_override: false

# =============================================================================
# COMPLIANCE RULES (Industry Standards)
# Pre-configured rules for common compliance frameworks
# =============================================================================
compliance_rules:
  # Enable compliance mode (stricter enforcement)
  enabled: false

  # Which frameworks to enforce
  frameworks: []  # Options: hipaa, soc2, pci_dss, gdpr

  # HIPAA (Healthcare)
  hipaa:
    enabled: false
    rules:
      - name: "phi_detection"
        description: "Detect and block PHI in code/logs"
        patterns:
          - "\\b\\d{3}-\\d{2}-\\d{4}\\b"  # SSN
          - "\\b\\d{9}\\b"                 # MRN patterns
          - "patient.*name"
          - "medical.*record"
        action: "block"
        message: "Potential PHI detected. Cannot commit."

      - name: "encryption_required"
        description: "Ensure data at rest encryption"
        check: "config_value"
        path: "*.env*"
        required_keys:
          - "ENCRYPTION_KEY"
          - "DATABASE_ENCRYPTION"

      - name: "audit_logging"
        description: "Audit logging must be enabled"
        require:
          audit_trail.enabled: true
          audit_trail.log_tool_uses: true

  # SOC2 (Service Organizations)
  soc2:
    enabled: false
    rules:
      - name: "access_control"
        description: "Verify access controls in auth code"
        patterns:
          - "TODO.*auth"
          - "FIXME.*permission"
          - "// skip auth"
        action: "warn"
        message: "Potential access control issue. Review required."

      - name: "change_management"
        description: "All changes must be tracked"
        require:
          enforcement.require_active_task: true
          audit_trail.enabled: true

      - name: "incident_logging"
        description: "Errors must be logged"
        check: "code_pattern"
        require_in_catch_blocks:
          - "console.error"
          - "logger.error"
          - "log.error"

  # PCI-DSS (Payment Card Industry)
  pci_dss:
    enabled: false
    rules:
      - name: "card_data_detection"
        description: "Block credit card numbers in code"
        patterns:
          - "\\b(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14})\\b"  # Visa/MC
          - "card.*number"
          - "cvv"
          - "cvc"
        action: "block"
        message: "Potential card data detected. Cannot commit."

      - name: "secure_transmission"
        description: "Require HTTPS for API calls"
        patterns:
          - "http://"  # Non-HTTPS
        exclude:
          - "localhost"
          - "127.0.0.1"
        action: "warn"

  # GDPR (Data Privacy)
  gdpr:
    enabled: false
    rules:
      - name: "pii_detection"
        description: "Detect PII in code/config"
        patterns:
          - "email.*=.*@"
          - "phone.*=.*\\d{10}"
          - "address.*=.*"
        action: "warn"
        message: "Potential PII hardcoded. Use environment variables."

      - name: "data_retention"
        description: "Verify data retention policies"
        require_in_models:
          - "deletedAt"
          - "retentionPolicy"

# =============================================================================
# AREA DEFINITIONS
# Maps file paths to domains and agents for multi-agent coordination
# =============================================================================
areas:
  frontend:
    paths:
      - "src/app/**"
      - "src/components/**"
      - "src/styles/**"
      - "src/hooks/**"
      - "app/**"
      - "components/**"
      - "pages/**"
    agent: "frontend-master"

  backend:
    paths:
      - "src/api/**"
      - "src/server/**"
      - "src/lib/**"
      - "src/services/**"
      - "api/**"
      - "server/**"
      - "lib/**"
    agent: "backend-master"

  database:
    paths:
      - "prisma/**"
      - "src/db/**"
      - "migrations/**"
      - "drizzle/**"
      - "db/**"
    agent: "database-master"

  infra:
    paths:
      - ".github/**"
      - "docker/**"
      - "infra/**"
      - "terraform/**"
      - "k8s/**"
    agent: null  # No specialized agent

  config:
    paths:
      - ".claude/**"
      - ".pilot-internal/**"
      - "work/**"
    agent: null  # Framework configuration

# =============================================================================
# SESSION MANAGEMENT
# Controls multi-session coordination and locking
# =============================================================================
session:
  # How often sessions send heartbeat (seconds)
  heartbeat_interval_sec: 60

  # How long a file/area lock is valid without heartbeat (minutes)
  lock_timeout_min: 30

  # Maximum concurrent Claude Code sessions
  max_concurrent_sessions: 6

  # Session state directory
  state_dir: ".claude/pilot/state/sessions"

  # Event stream file for session coordination
  event_stream: "runs/sessions.jsonl"

  # Task list display settings for session start
  task_list_display:
    # Maximum number of ready tasks to show at session start
    max_ready_tasks: 5
    # Show task priority in the list
    show_priority: true
    # Include task list summary in session context
    enabled: true

# =============================================================================
# WORKTREE ENGINE (Phase 2.1)
# Git worktree isolation for multi-agent parallel development
# =============================================================================
worktree:
  # Master switch for worktree isolation
  enabled: true

  # Directory for linked worktrees (relative to project root)
  base_dir: ".worktrees"

  # Branch prefix for agent worktree branches
  branch_prefix: "pilot/"

  # Merge strategy when completing a task: squash | merge
  merge_strategy: "squash"

  # What to do when merge conflicts are detected: flag | abort
  conflict_action: "flag"

  # Automatically clean up orphaned worktrees on session start
  auto_cleanup: true

  # Base branch to create worktrees from
  base_branch: "main"

# =============================================================================
# PM ORCHESTRATOR (Phase 2.4)
# Controls for the PM team-lead agent coordination
# =============================================================================
orchestrator:
  # Drift threshold: ratio of unplanned file edits that triggers alert
  # 0.3 = if 30% or more of modified files weren't in the plan, flag drift
  drift_threshold: 0.3

  # Require PM approval before merging agent work back to base branch
  require_merge_approval: true

  # Automatically reassign tasks from stale agents (lease expired + heartbeat gone)
  auto_reassign_stale: true

  # Maximum agents that can work in parallel
  max_concurrent_agents: 4

  # Require tests to pass before merge approval
  require_tests_pass: false

  # Cost tracking (token usage per agent/task)
  cost_tracking:
    enabled: true
    warn_threshold_tokens: 500000   # Warn at 500k tokens per task
    block_threshold_tokens: 2000000 # Block at 2M tokens per task

# =============================================================================
# CONTEXT CHECKPOINT (Phase 2.2.1)
# Proactive context window management for agent continuity
# =============================================================================
checkpoint:
  # Master switch for checkpoint system
  enabled: true

  # Context pressure threshold (percentage) â€” nudge agent at this level
  pressure_threshold_pct: 60

  # Automatically save checkpoint before context compaction
  auto_save_before_compact: true

  # Maximum checkpoint versions to keep per session (older ones rotated out)
  max_checkpoints_per_session: 5

# =============================================================================
# QUALITY GATES (optional, disabled by default)
# Pre-commit quality checks - these duplicate Claude Code native functionality
# Enable only if you need stricter checks than Claude Code provides
# =============================================================================
quality_gates:
  # Master switch - set to true to enable quality gates
  enabled: false

  # Individual gate configuration (when enabled)
  file_size:
    enabled: true
    warn: 300    # Lines to warn
    block: 500   # Lines to block
  lint:
    enabled: true
    timeout: 30000
  secrets:
    enabled: true
  security:
    enabled: true
  type_check:
    enabled: true
    timeout: 30000
  duplicate:
    enabled: false  # Expensive check, disabled by default

# =============================================================================
# EXCEPTIONS
# Files and patterns that bypass enforcement rules
# =============================================================================
exceptions:
  # Files that can be edited without an active task
  no_task_required:
    - "runs/*.md"           # Session logs
    - ".claude/pilot/state/**"  # Session state
    - "*.lock"              # Lock files

  # Files that don't require plan approval
  no_plan_required:
    - "runs/*.md"
    - ".gitignore"
    - "**/*.md"             # Documentation (nested paths too)

  # Files that are always blocked from editing (security)
  never_edit:
    - ".env"
    - ".env.*"
    - "*.pem"
    - "*.key"
    - "credentials.*"
