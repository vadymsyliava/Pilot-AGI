# yaml-language-server: $schema=./schemas/policy.schema.json
# Pilot AGI Governance Policy
# This file defines enforcement rules that control agent behavior.
# Hooks (session_start.js, user_prompt_submit.js, pre_tool_use.js) read this
# policy to enforce governance rules.
#
# POSITION: This is the definitive enterprise governance DSL for Claude Code.
# While Claude Code provides AI coding power, this policy ensures compliance.
#
# Version: 2.0
# Updated: 2026-01-25

version: "2.0"

# =============================================================================
# ENFORCEMENT RULES
# Controls what must be true before code edits are allowed
# =============================================================================
enforcement:
  # R1: Must have an active claimed task to edit files
  # When true, Edit/Write operations are blocked unless a bd task is claimed
  require_active_task: true

  # R2: Must have an approved plan for complex tasks
  # When true, blocks edits until plan is approved
  require_plan_approval: true

  # Plan approval threshold determines when plans are required:
  # - "low": Always require plan approval
  # - "medium": Require for tasks with 2+ steps (default)
  # - "high": Require only for tasks marked as complex
  plan_approval_threshold: "medium"

  # R3: Protected branches cannot be edited directly
  # Edit/Write blocked when on these branches
  protected_branches:
    - main
    - master
    - production

  # R4: Detect new scope in user messages (Semantic Guardian)
  # When true, user prompts are analyzed for new work requests
  # and routed to /pilot-new-task instead of direct implementation
  detect_new_scope: true

  # Keywords that trigger new scope detection
  new_scope_keywords:
    - "add feature"
    - "implement"
    - "create new"
    - "build"
    - "fix bug"
    - "add a"
    - "can you add"
    - "let's add"

# =============================================================================
# EXECUTION RULES
# Controls what must happen during and after each micro-step
# =============================================================================
execution:
  # R5: Run verification after each micro-step
  # Ensures changes work before moving to next step
  require_verification: true

  # R6: Create a commit after each micro-step
  # Keeps commits atomic and easy to review/revert
  require_commit_per_step: true

  # R7: Update session run log after each action
  # Maintains crash recovery context in runs/YYYY-MM-DD.md
  require_run_log_update: true

  # R8: Update bd task status after state changes
  # Keeps bd as the single source of truth for task state
  require_bd_update: true

# =============================================================================
# AUDIT TRAIL (Enterprise Compliance)
# Configures comprehensive logging for compliance audits
# =============================================================================
audit_trail:
  # Master switch for audit logging
  enabled: true

  # Log all tool uses (for SOC2, HIPAA compliance)
  log_tool_uses: true

  # Log format: "json" for machine parsing, "markdown" for humans
  format: "json"

  # Where to write audit logs
  log_file: "runs/audit.jsonl"

  # What to capture in each log entry
  capture:
    - timestamp
    - session_id
    - user_id
    - task_id
    - tool_name
    - tool_args_hash      # Hash of args (not full content for PII)
    - result_status       # success/failure
    - files_touched

  # Retention policy
  retention:
    days: 90
    archive_to: "runs/archive/"

  # Events that always get logged regardless of other settings
  always_log:
    - file_edit
    - file_delete
    - bash_command
    - plan_approval
    - task_claim
    - task_close

# =============================================================================
# APPROVAL MATRIX (Role-Based Access Control)
# Defines who can approve what types of changes
# =============================================================================
approval_matrix:
  # Default approval requirements
  defaults:
    # Can the AI auto-approve simple changes?
    ai_auto_approve: false
    # Require explicit human approval for all changes
    require_human: true

  # Change types and their approval requirements
  change_types:
    # Standard code changes - default approval
    code_change:
      ai_auto_approve: true
      require_human: false
      escalate_if:
        - files_changed > 10
        - touches_auth_code
        - touches_payment_code

    # Documentation changes - can be auto-approved
    documentation:
      ai_auto_approve: true
      require_human: false

    # Database migrations - always require human
    database_migration:
      ai_auto_approve: false
      require_human: true
      approvers:
        - tech_lead
        - dba
      notify:
        - ops_team

    # Authentication/authorization changes - critical
    auth_change:
      ai_auto_approve: false
      require_human: true
      approvers:
        - security_team
        - tech_lead
      notify:
        - security_team

    # File deletions - require confirmation
    file_deletion:
      ai_auto_approve: false
      require_human: true
      warn_message: "This action will delete files permanently."

    # Design token changes - auto-approvable but require republish
    design_token_change:
      ai_auto_approve: true
      require_human: false
      escalate_if:
        - removes_token_category
        - changes_semantic_color_mapping
      checklist:
        - "Token validation passes?"
        - "Shared memory republished?"
        - "CSS and Tailwind config regenerated?"
        - "Dark mode variants included?"

    # External API integrations - review required
    external_api:
      ai_auto_approve: false
      require_human: true
      approvers:
        - tech_lead
      checklist:
        - "API key stored in secrets manager?"
        - "Rate limiting implemented?"
        - "Error handling complete?"

    # Production deployments - highest approval
    production_deploy:
      ai_auto_approve: false
      require_human: true
      require_multiple_approvers: true
      min_approvers: 2
      approvers:
        - tech_lead
        - ops_team
        - product_owner

  # Role definitions (map to actual users/groups externally)
  roles:
    tech_lead:
      can_approve: all
      can_override: true
    security_team:
      can_approve: [auth_change, production_deploy]
      can_override: false
    dba:
      can_approve: [database_migration]
      can_override: false
    ops_team:
      can_approve: [production_deploy]
      can_override: false
    product_owner:
      can_approve: [production_deploy]
      can_override: false

# =============================================================================
# COMPLIANCE RULES (Industry Standards)
# Pre-configured rules for common compliance frameworks
# =============================================================================
compliance_rules:
  # Enable compliance mode (stricter enforcement)
  enabled: false

  # Which frameworks to enforce
  frameworks: []  # Options: hipaa, soc2, pci_dss, gdpr

  # HIPAA (Healthcare)
  hipaa:
    enabled: false
    rules:
      - name: "phi_detection"
        description: "Detect and block PHI in code/logs"
        patterns:
          - "\\b\\d{3}-\\d{2}-\\d{4}\\b"  # SSN
          - "\\b\\d{9}\\b"                 # MRN patterns
          - "patient.*name"
          - "medical.*record"
        action: "block"
        message: "Potential PHI detected. Cannot commit."

      - name: "encryption_required"
        description: "Ensure data at rest encryption"
        check: "config_value"
        path: "*.env*"
        required_keys:
          - "ENCRYPTION_KEY"
          - "DATABASE_ENCRYPTION"

      - name: "audit_logging"
        description: "Audit logging must be enabled"
        require:
          audit_trail.enabled: true
          audit_trail.log_tool_uses: true

  # SOC2 (Service Organizations)
  soc2:
    enabled: false
    rules:
      - name: "access_control"
        description: "Verify access controls in auth code"
        patterns:
          - "TODO.*auth"
          - "FIXME.*permission"
          - "// skip auth"
        action: "warn"
        message: "Potential access control issue. Review required."

      - name: "change_management"
        description: "All changes must be tracked"
        require:
          enforcement.require_active_task: true
          audit_trail.enabled: true

      - name: "incident_logging"
        description: "Errors must be logged"
        check: "code_pattern"
        require_in_catch_blocks:
          - "console.error"
          - "logger.error"
          - "log.error"

  # PCI-DSS (Payment Card Industry)
  pci_dss:
    enabled: false
    rules:
      - name: "card_data_detection"
        description: "Block credit card numbers in code"
        patterns:
          - "\\b(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14})\\b"  # Visa/MC
          - "card.*number"
          - "cvv"
          - "cvc"
        action: "block"
        message: "Potential card data detected. Cannot commit."

      - name: "secure_transmission"
        description: "Require HTTPS for API calls"
        patterns:
          - "http://"  # Non-HTTPS
        exclude:
          - "localhost"
          - "127.0.0.1"
        action: "warn"

  # GDPR (Data Privacy)
  gdpr:
    enabled: false
    rules:
      - name: "pii_detection"
        description: "Detect PII in code/config"
        patterns:
          - "email.*=.*@"
          - "phone.*=.*\\d{10}"
          - "address.*=.*"
        action: "warn"
        message: "Potential PII hardcoded. Use environment variables."

      - name: "data_retention"
        description: "Verify data retention policies"
        require_in_models:
          - "deletedAt"
          - "retentionPolicy"

# =============================================================================
# AREA DEFINITIONS
# Maps file paths to domains and agents for multi-agent coordination
# =============================================================================
areas:
  frontend:
    paths:
      - "src/app/**"
      - "src/components/**"
      - "src/styles/**"
      - "src/hooks/**"
      - "app/**"
      - "components/**"
      - "pages/**"
    agent: "frontend-master"

  backend:
    paths:
      - "src/api/**"
      - "src/server/**"
      - "src/lib/**"
      - "src/services/**"
      - "api/**"
      - "server/**"
      - "lib/**"
    agent: "backend-master"

  database:
    paths:
      - "prisma/**"
      - "src/db/**"
      - "migrations/**"
      - "drizzle/**"
      - "db/**"
    agent: "database-master"

  design:
    paths:
      - "design/**"
      - "**/tokens/**"
      - "**/design-system/**"
    agent: "design-master"

  infra:
    paths:
      - ".github/**"
      - "docker/**"
      - "infra/**"
      - "terraform/**"
      - "k8s/**"
    agent: null  # No specialized agent

  config:
    paths:
      - ".claude/**"
      - ".pilot-internal/**"
      - "work/**"
    agent: null  # Framework configuration

# =============================================================================
# SESSION MANAGEMENT
# Controls multi-session coordination and locking
# =============================================================================
session:
  # How often sessions send heartbeat (seconds)
  heartbeat_interval_sec: 60

  # How long a file/area lock is valid without heartbeat (minutes)
  lock_timeout_min: 30

  # Maximum concurrent Claude Code sessions
  max_concurrent_sessions: 6

  # Session state directory
  state_dir: ".claude/pilot/state/sessions"

  # Event stream file for session coordination
  event_stream: "runs/sessions.jsonl"

  # Task list display settings for session start
  task_list_display:
    # Maximum number of ready tasks to show at session start
    max_ready_tasks: 5
    # Show task priority in the list
    show_priority: true
    # Include task list summary in session context
    enabled: true

# =============================================================================
# WORKTREE ENGINE (Phase 2.1)
# Git worktree isolation for multi-agent parallel development
# =============================================================================
worktree:
  # Master switch for worktree isolation
  enabled: true

  # Directory for linked worktrees (relative to project root)
  base_dir: ".worktrees"

  # Branch prefix for agent worktree branches
  branch_prefix: "pilot/"

  # Merge strategy when completing a task: squash | merge
  merge_strategy: "squash"

  # What to do when merge conflicts are detected: flag | abort
  conflict_action: "flag"

  # Automatically clean up orphaned worktrees on session start
  auto_cleanup: true

  # Base branch to create worktrees from
  base_branch: "main"

  # Semantic merge conflict resolution (Phase 5.2)
  merge_resolution:
    # Master switch for auto-resolution
    enabled: true

    # Confidence thresholds for auto-resolution decisions
    # Resolutions above 'high' are applied without review
    # Between 'medium' and 'high' are applied with logging
    # Below 'medium' are escalated to human
    confidence_high: 0.85
    confidence_medium: 0.60

    # Maximum conflict size in bytes for auto-resolution
    max_conflict_size: 8000

    # Supported languages for structural analysis
    languages:
      - javascript
      - typescript
      - python
      - go
      - rust

    # Require test validation after auto-resolution
    test_validation: true

# =============================================================================
# PM ORCHESTRATOR (Phase 2.4)
# Controls for the PM team-lead agent coordination
# =============================================================================
orchestrator:
  # Drift threshold: ratio of unplanned file edits that triggers alert
  # 0.3 = if 30% or more of modified files weren't in the plan, flag drift
  drift_threshold: 0.3

  # Require PM approval before merging agent work back to base branch
  require_merge_approval: true

  # Automatically reassign tasks from stale agents (lease expired + heartbeat gone)
  auto_reassign_stale: true

  # Maximum agents that can work in parallel
  max_concurrent_agents: 4

  # Require tests to pass before merge approval
  require_tests_pass: false

  # Cost tracking (token usage per agent/task) — Phase 3.11
  cost_tracking:
    enabled: true
    # Per-task budgets (existing thresholds, now part of structured budget)
    warn_threshold_tokens: 500000   # Warn at 500k tokens per task
    block_threshold_tokens: 2000000 # Block at 2M tokens per task
    # Per-agent-per-day budgets
    per_agent_per_day:
      warn_tokens: 1000000          # Warn at 1M tokens/agent/day
      block_tokens: 3000000         # Block at 3M tokens/agent/day
    # Per-day budgets (all agents combined)
    per_day:
      warn_tokens: 5000000          # Warn at 5M tokens/day total
      block_tokens: 10000000        # Block at 10M tokens/day total
    # Enforcement mode: "soft" = warn only, "hard" = block edits
    enforcement: "soft"

  # Intelligent Task Scheduler — Phase 3.4
  scheduling:
    # Score weights (must sum to 1.0)
    skill_weight: 0.55          # Skill match from scoreAgentForTask
    load_weight: 0.20           # Agent availability / load balance
    affinity_weight: 0.15       # Historical success with similar tasks
    cost_weight: 0.10           # Token cost efficiency

    # Load balancing
    max_tasks_per_agent: 3      # Soft cap on concurrent tasks
    complexity_multiplier:
      S: 1
      M: 2
      L: 3

    # Starvation prevention
    starvation_threshold_sec: 300   # 5 min wait before priority boost
    starvation_boost_per_sec: 0.001 # Boost per second past threshold

  # Performance Analytics — Phase 3.13
  analytics:
    enabled: true
    scan_interval_sec: 300           # 5 min between analytics aggregation
    retention_days: 30               # Keep daily snapshots for 30 days
    slow_task_threshold_min: 30      # Task cycle time to flag as "slow"
    rework_alert_threshold: 0.3      # Rework rate to flag agents (30%)
    queue_depth_warning: 5           # Unassigned ready tasks before warning

  # Auto-Escalation Engine — Phase 3.12
  escalation:
    # Master switch
    enabled: true

    # How often PM loop runs escalation scan (seconds)
    scan_interval_sec: 60

    # Escalation paths — progressive severity per event type
    # Each path defines ordered levels and cooldown between escalations
    # Levels: warning → block → reassign → human
    paths:
      drift:
        levels: [warning, block, reassign, human]
        cooldown_sec: 120           # 2 min between escalation steps
        auto_deescalate: true       # Resolve if drift clears

      test_failure:
        levels: [warning, reassign, human]
        cooldown_sec: 60            # 1 min — test failures need fast response
        auto_deescalate: true       # Resolve if tests pass again

      budget_exceeded:
        levels: [warning, block, human]
        cooldown_sec: 300           # 5 min — budget issues are slow to resolve
        auto_deescalate: false      # Requires manual budget review

      merge_conflict:
        levels: [warning, block, reassign, human]
        cooldown_sec: 60
        auto_deescalate: true       # Resolve if conflict is fixed

      agent_unresponsive:
        levels: [warning, reassign, human]
        cooldown_sec: 30            # 30s — unresponsive needs quick escalation
        auto_deescalate: false      # Agent must actively recover

# =============================================================================
# DECOMPOSITION FEEDBACK LOOP (Phase 5.5)
# Self-improving task decomposition via outcome tracking and pattern matching
# =============================================================================
decomposition:
  feedback_loop:
    # Master switch for feedback loop
    enabled: true

    # Minimum pattern success rate to use as template (0.0 - 1.0)
    min_confidence: 0.7

    # Minimum keyword match score to consider a pattern (0.0 - 1.0)
    pattern_match_threshold: 0.5

    # Maximum patterns stored per task type before pruning
    max_patterns_per_type: 50

# =============================================================================
# ADAPTIVE PLAN APPROVAL (Phase 5.1)
# Confidence-based tiered approval: auto, notify, require
# =============================================================================
approval:
  # Confidence thresholds (0.0 - 1.0)
  # Plans above auto_threshold are auto-approved without human input
  # Plans between notify and auto are approved with notification log
  # Plans below notify_threshold require explicit human approval
  confidence_thresholds:
    auto: 0.85        # >= 0.85 → auto-approve (routine, familiar, low risk)
    notify: 0.60      # >= 0.60 → notify-approve (log but proceed)
    # Below 0.60 → require-approve (block until human confirms)

  # Scoring weights (must sum to 1.0)
  # Each factor produces a 0.0-1.0 score, weighted and combined
  confidence_weights:
    scope: 0.25       # Task scope: fewer files/lines = higher confidence
    risk: 0.30        # Risk level: lower risk dimensions = higher confidence
    familiarity: 0.25 # Code area familiarity: more history = higher confidence
    history: 0.20     # Historical outcomes: past success = higher confidence

  # Scope scoring — maps file/line counts to confidence
  scope_thresholds:
    # Number of files touched
    files_low: 3      # <= 3 files = high scope confidence (1.0)
    files_medium: 8   # <= 8 files = medium scope confidence (0.6)
    # > 8 files = low scope confidence (0.3)

    # Estimated lines changed
    lines_low: 100    # <= 100 lines = high confidence
    lines_medium: 300 # <= 300 lines = medium confidence
    # > 300 lines = low confidence

  # Risk patterns — grep patterns that indicate risk dimensions
  # Each dimension scored 0.0 (safe) to 1.0 (risky)
  risk_patterns:
    data_loss:
      - "fs.rmSync"
      - "fs.unlinkSync"
      - "DROP TABLE"
      - "DELETE FROM"
      - "truncate"
      - ".destroy()"
      - "rm -rf"
    user_facing:
      - "src/app/"
      - "src/components/"
      - "pages/"
      - "app/"
      - "components/"
      - "*.tsx"
      - "*.jsx"
    security_sensitive:
      - "auth"
      - "login"
      - "password"
      - "token"
      - "secret"
      - "encrypt"
      - "permission"
      - "*.pem"
      - "*.key"
    infra_touching:
      - ".github/"
      - "docker"
      - "Dockerfile"
      - "terraform"
      - "k8s/"
      - "deploy"
      - "ci/"
      - "cd/"
      - ".yml"

  # Historical outcome tracking
  outcomes:
    # State directory for plan outcome records
    state_dir: ".claude/pilot/state/plan-outcomes"
    # Minimum outcomes needed before history affects confidence
    min_samples: 5
    # How much historical success/failure shifts the score
    history_weight_factor: 0.3
    # Days of history to consider (older outcomes decay)
    lookback_days: 30

  # Override: always require human approval for these areas
  always_require_approval:
    - "production_deploy"
    - "database_migration"
    - "auth_change"

  # Override: always auto-approve these (regardless of confidence)
  always_auto_approve:
    - "documentation"
    - "**.md"
    - "runs/*.md"

# =============================================================================
# AUTONOMY (Full Agent Loop)
# Controls whether agents run continuously without human intervention
# =============================================================================
autonomy:
  # "manual" = agent stops for approval at each step (default)
  # "full"   = agent loops continuously: plan -> exec all -> commit -> close -> next
  mode: "full"

  # Auto-approve plans without human confirmation
  auto_approve_plans: true

  # Execute all plan steps in sequence without stopping
  auto_advance_steps: true

  # Commit after each step automatically
  auto_commit_steps: true

  # After closing a task, auto-pick and start the next one
  auto_chain_on_close: true

  # Stop the loop if verification fails
  stop_on_error: true

  # Maximum tasks an agent can complete in one session
  max_tasks_per_session: 10

  # Stop after this many consecutive errors
  max_consecutive_errors: 3

# =============================================================================
# CONTEXT CHECKPOINT (Phase 2.2.1)
# Proactive context window management for agent continuity
# =============================================================================
checkpoint:
  # Master switch for checkpoint system
  enabled: true

  # Context pressure threshold (percentage) — nudge agent at this level
  pressure_threshold_pct: 60

  # Automatically save checkpoint before context compaction
  auto_save_before_compact: true

  # Maximum checkpoint versions to keep per session (older ones rotated out)
  max_checkpoints_per_session: 5

  # Checkpoint-Respawn Loop (Phase 4.3)
  # When enabled, agents exit cleanly on checkpoint and PM respawns them
  respawn:
    # Master switch for exit-on-checkpoint behavior
    enabled: true

    # Maximum respawns per task before escalating to human
    max_respawn_limit: 10

    # Minimum seconds between respawns (prevents rapid loops)
    cooldown_sec: 5

    # Pressure threshold to trigger exit-on-checkpoint
    # (uses checkpoint.pressure_threshold_pct if not set)
    exit_threshold_pct: null

# =============================================================================
# OVERNIGHT MODE (Phase 4.8)
# Autonomous batch execution with error budgets and morning reports
# =============================================================================
overnight:
  # Error budget — limits consecutive and total failures
  error_budget:
    # Max consecutive failures per task before pausing it
    max_failures_per_task: 3
    # Max total failures across all tasks before stopping the run
    max_total_failures: 10

  # Report generation
  report:
    # Auto-generate markdown report when run completes
    auto_generate: true

  # Drain mode — graceful shutdown
  drain:
    # Max minutes to wait for active agents to finish during drain
    timeout_min: 15

# =============================================================================
# MEMORY CONSOLIDATION (Phase 5.7)
# Relevance scoring, summarization, tiered loading, and budget management
# =============================================================================
memory:
  # Relevance scoring weights (must sum to 1.0)
  relevance_weights:
    recency: 0.30       # How recently the entry was created/updated
    frequency: 0.25     # How often the entry has been accessed
    similarity: 0.25    # Semantic similarity to current task context
    links: 0.20         # Cross-references from other entries/channels

  # Per-channel memory budgets (max entries before eviction)
  budgets:
    default: 100         # Default budget for any channel
    overrides:
      design-tokens: 200   # Design tokens need more capacity
      working-context: 50  # Working context is ephemeral
      decisions: 150       # Decision log is high-value, keep more

  # Summarization pipeline configuration
  summarization:
    # Minimum relevance score to keep entry at full fidelity
    full_fidelity_threshold: 0.6

    # Days after last access before summarizing (full → summary)
    summary_after_days: 7

    # Days after last access before archiving (summary → archived)
    archive_after_days: 30

    # Maximum summary length (characters)
    max_summary_length: 500

    # Minimum entries before triggering consolidation pass
    min_entries_for_consolidation: 20

  # Tiered loading configuration
  loading:
    # Minimum relevance score to include in context load
    relevance_threshold: 0.3

    # Maximum entries to load per channel per request
    max_entries_per_load: 20

    # Maximum total entries across all channels per load
    max_total_per_load: 50

    # Tiers: full (score >= 0.7), summary (0.3-0.7), skip (< 0.3)
    tier_thresholds:
      full: 0.7
      summary: 0.3

  # Eviction policy
  eviction:
    # Strategy: lru (least recently used) or lrs (lowest relevance score)
    strategy: "lru"

    # Run eviction when channel reaches this % of budget
    trigger_pct: 90

    # Evict down to this % of budget
    target_pct: 75

# =============================================================================
# QUALITY GATES (optional, disabled by default)
# Pre-commit quality checks - these duplicate Claude Code native functionality
# Enable only if you need stricter checks than Claude Code provides
# =============================================================================
quality_gates:
  # Master switch - set to true to enable quality gates
  enabled: false

  # Individual gate configuration (when enabled)
  file_size:
    enabled: true
    warn: 300    # Lines to warn
    block: 500   # Lines to block
  lint:
    enabled: true
    timeout: 30000
  secrets:
    enabled: true
  security:
    enabled: true
  type_check:
    enabled: true
    timeout: 30000
  duplicate:
    enabled: false  # Expensive check, disabled by default

# =============================================================================
# EXCEPTIONS
# Files and patterns that bypass enforcement rules
# =============================================================================
exceptions:
  # Files that can be edited without an active task
  no_task_required:
    - "runs/*.md"           # Session logs
    - ".claude/pilot/state/**"  # Session state
    - "*.lock"              # Lock files

  # Files that don't require plan approval
  no_plan_required:
    - "runs/*.md"
    - ".gitignore"
    - "**/*.md"             # Documentation (nested paths too)

  # Files that are always blocked from editing (security)
  never_edit:
    - ".env"
    - ".env.*"
    - "*.pem"
    - "*.key"
    - "credentials.*"

# =============================================================================
# TEST GENERATION (Phase 5.3)
# Auto-generate tests after code changes during /pilot-exec
# =============================================================================
test_generation:
  # Enable/disable autonomous test generation
  enabled: false

  # Run coverage gate after generating tests
  coverage_gate: false

  # Minimum coverage percentage for changed lines (0-100)
  min_coverage: 0

  # Change types to skip (no tests generated)
  skip_types:
    - config_change
    - deleted_file
    - test_change
    - docs_change

# =============================================================================
# TELEGRAM BRIDGE (Phase 6.5)
# Remote human interface via Telegram bot
# =============================================================================
telegram:
  # Master switch — opt-in only
  enabled: false

  # Numeric Telegram chat IDs authorized to interact with the bot.
  # Get yours: message @userinfobot on Telegram
  # SECURITY: Empty list = reject all (secure default, not open dev mode)
  allowed_chat_ids: []

  # Bot token stored in env var PILOT_TELEGRAM_TOKEN (never in this file)

  # Rate limiting per authorized user
  rate_limit:
    per_minute: 10
    per_hour: 100

  # Which PM events trigger proactive Telegram notifications
  notifications:
    escalations: true
    task_complete: true
    errors: true
    morning_report: true
    morning_report_time: "08:00"
    sprint_complete: true
    budget_alert: true
    agent_stall: true

  # Escalation approval via Telegram inline buttons
  approval:
    enabled: true
    timeout_minutes: 60

  # Actions requiring double-confirmation via inline keyboard
  confirmation_required:
    - pause_all
    - cancel_sprint
    - kill_agent
    - change_priority

  # Audit every Telegram interaction
  audit_log: true

  # Emergency kill switch phrase (case-insensitive)
  kill_switch_phrase: "LOCKDOWN"

# =============================================================================
# NOTIFICATIONS (Phase 5.9)
# Real-time notification system — channels, routing, and digest
# =============================================================================
notifications:
  # Channel configurations
  # Each channel is opt-in: set enabled: true and provide credentials
  channels:
    # macOS system notifications (always available, no config needed)
    system:
      enabled: true

    # Slack — provide webhook URL from Slack > Apps > Incoming Webhooks
    slack:
      enabled: false
      # webhook_url: "https://hooks.slack.com/services/T00/B00/xxxx"

    # Discord — provide webhook URL from Server Settings > Integrations
    discord:
      enabled: false
      # webhook_url: "https://discord.com/api/webhooks/xxxx/yyyy"

    # Email — SMTP configuration
    email:
      enabled: false
      # smtp_host: "smtp.gmail.com"
      # smtp_port: 587
      # smtp_user: ""
      # smtp_pass: ""  # Use env var PILOT_SMTP_PASS instead
      # from: "pilot-agi@yourdomain.com"
      # to: "you@yourdomain.com"

  # Primary channel for warning-level notifications (default: system)
  primary_channel: "system"

  # Digest interval for info-level notifications (minutes)
  digest_interval_minutes: 30

  # Event routing overrides — send specific events to specific channels
  # Each key is an event type, value has channels list
  routing:
    # escalation.human:
    #   channels: ["slack", "system", "email"]
    # morning_report:
    #   channels: ["slack", "email"]

  # Morning report schedule (24h format)
  morning_report_time: "08:00"

  # Event types that trigger notifications
  events:
    escalation_human: true
    escalation_warning: true
    task_complete: true
    sprint_complete: true
    budget_alert: true
    agent_stall: true
    morning_report: true
    error_budget_exceeded: true

# =============================================================================
# TERMINAL ORCHESTRATION (Phase 6.4)
# PM Daemon integration with physical terminal tabs for agent management
# =============================================================================
terminal_orchestration:
  # Master switch — disabled by default, opt-in
  enabled: true

  # Provider: 'auto' (iTerm2 → AppleScript), 'iterm2', 'applescript'
  provider: 'auto'

  # How to spawn agent tabs: 'tab' (recommended), 'window', 'split'
  spawn_mode: 'tab'

  # Terminal scan interval in the PM daemon tick loop (ms)
  scan_interval_ms: 10000

  # Stall detection threshold — agent with no state change exceeding this is stalled
  stall_threshold_ms: 300000

  # Auto-approve permission prompts in terminal tabs
  auto_approve:
    # Master switch for auto-approval
    enabled: true
    # Auto-approve plan approval prompts
    plan_approval: true
    # Auto-approve tool permission prompts
    permission: true

  # Dynamic scaling based on queue depth
  scaling:
    enabled: true
    min_agents: 1
    max_agents: 8
    # Spawn new agent when ready_tasks exceeds this
    queue_depth_target: 3
    # Cooldown between scale-up decisions (ms)
    cooldown_ms: 10000

  # Stall recovery settings
  recovery:
    enabled: true
    # Automatically restart stalled agents
    restart_on_stall: true
    # Maximum restarts per task before escalating
    max_restarts_per_task: 3
    # Escalate to human when restart limit exceeded
    escalate_on_exceed: true

# =============================================================================
# DRIFT PREVENTION (Phase 5.6)
# Predictive pre-action drift detection and course correction
# =============================================================================
drift_prevention:
  # Master switch
  enabled: true

  # Similarity score thresholds
  thresholds:
    aligned: 0.6        # score >= 0.6: no intervention
    monitor: 0.3        # 0.3 <= score < 0.6: warn + log
    divergent: 0.3      # score < 0.3: redirect or refresh

  # Guardrail behavior
  guardrails:
    warn_on_monitor: true        # Log warning on monitor-level drift
    block_on_divergent: true     # Block tool execution on divergent drift
    auto_refresh: true           # Refresh context on confusion before blocking

  # Tools exempt from drift check (read-only tools)
  excluded_tools:
    - Read
    - Glob
    - Grep
    - WebSearch
    - WebFetch

  # Check every N tool invocations (1 = every tool call)
  evaluation_interval_steps: 1

# =============================================================================
# POOL AUTOSCALING (Phase 5.4)
# Dynamic agent pool sizing based on queue depth, resources, and budget
# =============================================================================
pool:
  # Pool size bounds
  min: 1
  max: 12

  # Scale-up triggers
  scale_up:
    # Scale up when queue_depth / active_agents >= this ratio
    queue_ratio: 2.0
    # Scale up if idle agents <= this threshold and tasks are pending
    priority_idle_threshold: 0
    # Scale up if a task deadline is within N hours
    deadline_hours: 2

  # Scale-down triggers
  scale_down:
    # Minutes with no pending tasks before scaling down
    idle_cooldown_minutes: 5
    # Scale down when daily budget usage exceeds this percentage
    budget_threshold_pct: 90
    # Scale down when CPU exceeds this percentage
    cpu_threshold_pct: 80
    # Scale down when memory exceeds this percentage
    memory_threshold_pct: 85

  # How often to evaluate scaling decisions (seconds)
  evaluation_interval_seconds: 60

# =============================================================================
# CLOUD EXECUTION BRIDGE (Phase 5.10)
# Pluggable execution providers for local, SSH, and Docker agent execution
# =============================================================================
execution:
  # Active provider: local | ssh | docker
  active_provider: "local"

  # Provider-specific configurations
  providers:
    ssh:
      hosts: []
      # Example host config:
      # hosts:
      #   - host: "build-server-1"
      #     user: "pilot"
      #     port: 22
      #     key_path: "~/.ssh/id_rsa"
      #     remote_path: "/home/pilot/workspace"
      #     max_agents: 4

    docker:
      image: "pilot-agi:latest"
      network: "pilot-net"
      cpu_limit: "2"
      mem_limit: "4g"
      max_containers: 8

  # State synchronization between local and remote
  state_sync:
    method: "git"               # git | rsync
    auto_sync: true
    sync_interval_seconds: 300

# =============================================================================
# CROSS-PROJECT LEARNING (Phase 5.8)
# Share anonymized knowledge across projects
# =============================================================================
cross_project:
  # Master switch — opt-in only
  enabled: true

  # Allow publishing anonymized learnings to global knowledge base
  publish: true

  # Allow consuming knowledge from other projects
  consume: true

  # Anonymization level: "full" | "partial" | "none"
  anonymize_level: "full"

  # Patterns to never export (matched against content)
  exclude_patterns:
    - "*.env"
    - "*secret*"
    - "*password*"
    - "*token*"

  # Custom knowledge path (null = ~/.pilot-agi/knowledge/)
  knowledge_path: null

  # Maximum entries per knowledge type before pruning
  max_entries_per_type: 500

  # Prune entries older than N days (with zero usage)
  prune_after_days: 90

# =============================================================================
# GITHUB PR AUTOMATION (Phase 5.11)
# Controls automatic PR creation, CI monitoring, and auto-merge
# =============================================================================
github:
  # Master switch — opt-in only (fallback: local merge)
  enabled: false

  # Create PR when task completes
  pr_on_complete: true

  # Auto-merge when CI checks pass + PM approves
  auto_merge: false

  # Push branch to remote on task complete
  auto_push: true

  # PR merge strategy: squash | merge | rebase
  merge_strategy: "squash"

  # Delete remote branch after PR merge
  delete_branch_after_merge: true

  # PR template: "default" or path to custom template
  pr_template: "default"

  # Wait for CI checks to pass before merge
  require_checks_pass: true

  # Commit atomicity enforcement
  commit_enforcement:
    max_lines_per_commit: 500
    require_conventional: true
    block_on_violation: false

  # Labels applied to auto-created PRs
  labels:
    - "pilot-agi"
    - "auto-generated"

  # GitHub usernames for PR reviewers (empty = none required)
  reviewers: []

  # Target branch for PRs
  base_branch: "main"

  # CI check monitoring
  ci_timeout_minutes: 30

  # PM loop PR monitor scan interval (seconds)
  pr_monitor_scan_interval_sec: 60
