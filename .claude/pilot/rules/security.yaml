# Security Agent Validation Rules
# Purpose: Ensure secure code practices across the entire codebase

version: "1.0"
scope: security
applies_to:
  - frontend
  - backend
  - infrastructure

# =============================================================================
# MUST RULES - Required security behaviors
# =============================================================================
must:
  authentication:
    rule: "Implement proper authentication"
    requirements:
      password_storage:
        - "Hash passwords with bcrypt (cost factor >= 12)"
        - "Never store plain text passwords"
        - "Use salt per password"
      session_management:
        - "Use secure, httpOnly cookies"
        - "Implement session expiration"
        - "Invalidate sessions on logout"
        - "Regenerate session ID after login"
      multi_factor:
        - "Support 2FA for sensitive operations"
        - "Use time-based OTP (TOTP)"

  authorization:
    rule: "Enforce least privilege access"
    requirements:
      - "Check permissions on every request"
      - "Deny by default"
      - "Use role-based access control (RBAC)"
      - "Validate resource ownership"
    patterns:
      good: |
        if (!user.can('edit', resource)) {
          throw new ForbiddenError();
        }
      bad: |
        // No auth check, assumes user has access
        await resource.update(data);

  input_sanitization:
    rule: "Sanitize all user inputs"
    against:
      xss:
        - "Escape HTML entities in user content"
        - "Use Content-Security-Policy headers"
        - "Sanitize rich text input"
      sql_injection:
        - "Use parameterized queries only"
        - "Never concatenate user input to SQL"
      command_injection:
        - "Never pass user input to shell commands"
        - "Use allowlist for permitted values"

  data_encryption:
    rule: "Encrypt sensitive data"
    requirements:
      in_transit:
        - "Use TLS 1.3 for all connections"
        - "Enforce HTTPS with HSTS"
        - "Valid SSL certificates"
      at_rest:
        - "Encrypt sensitive database fields"
        - "Use AES-256 for encryption"
        - "Secure key management"

  secure_headers:
    rule: "Set security headers on all responses"
    headers:
      Content-Security-Policy: "default-src 'self'"
      X-Content-Type-Options: "nosniff"
      X-Frame-Options: "DENY"
      Strict-Transport-Security: "max-age=31536000; includeSubDomains"
      X-XSS-Protection: "1; mode=block"
      Referrer-Policy: "strict-origin-when-cross-origin"

  dependency_security:
    rule: "Keep dependencies secure and updated"
    requirements:
      - "Run npm audit before releases"
      - "Update dependencies with security patches"
      - "Use lockfiles (package-lock.json)"
      - "Review new dependencies before adding"

  secrets_management:
    rule: "Properly manage secrets"
    requirements:
      - "Use environment variables for secrets"
      - "Never commit secrets to git"
      - "Rotate secrets periodically"
      - "Use secret managers in production"
    tools:
      - "dotenv for development"
      - "AWS Secrets Manager / Vault for production"

  logging_audit:
    rule: "Implement security logging and audit trails"
    events_to_log:
      - "Authentication attempts (success/failure)"
      - "Authorization failures"
      - "Password changes"
      - "Sensitive data access"
      - "Admin actions"
    format:
      timestamp: "ISO 8601"
      user_id: "Authenticated user"
      action: "What was attempted"
      resource: "What was accessed"
      result: "success/failure"
      ip_address: "Client IP"

  error_handling:
    rule: "Handle errors without leaking information"
    requirements:
      - "Generic error messages to users"
      - "Detailed errors only in logs"
      - "No stack traces in production responses"
      - "No database error details exposed"

# =============================================================================
# MUST_NOT RULES - Prohibited security patterns
# =============================================================================
must_not:
  hardcoded_secrets:
    rule: "Do not hardcode secrets in source code"
    examples:
      prohibited:
        - "const API_KEY = 'sk-abc123...'"
        - "password: 'admin123'"
        - "JWT_SECRET = 'mysecret'"
      correct:
        - "const API_KEY = process.env.API_KEY"
        - "Read from secrets manager"

  insecure_direct_object_reference:
    rule: "Do not expose internal IDs without authorization"
    description: |
      Users should not be able to access resources by guessing IDs.
    prohibited:
      - "/api/users/123 without auth check"
      - "Incrementing IDs to access other records"
    solution:
      - "Always verify ownership/permission"
      - "Use UUIDs instead of sequential IDs"

  sensitive_data_exposure:
    rule: "Do not expose sensitive data in responses"
    prohibited_in_responses:
      - "Password hashes"
      - "Internal user IDs (use public IDs)"
      - "Credit card numbers (mask them)"
      - "Social security numbers"
      - "API keys"
    pattern: |
      // Use DTOs to control what's exposed
      return {
        id: user.publicId,
        name: user.name,
        // NOT: password, internalId, ssn
      };

  insecure_crypto:
    rule: "Do not use weak cryptographic practices"
    prohibited:
      - "MD5 for any security purpose"
      - "SHA1 for passwords"
      - "ECB mode for encryption"
      - "Custom encryption algorithms"
      - "Hardcoded IVs or salts"
    use_instead:
      passwords: "bcrypt, argon2"
      hashing: "SHA-256, SHA-3"
      encryption: "AES-256-GCM"
      tokens: "crypto.randomBytes()"

  cors_misconfiguration:
    rule: "Do not use overly permissive CORS"
    prohibited:
      - "Access-Control-Allow-Origin: *"
      - "Access-Control-Allow-Credentials with wildcard origin"
    correct:
      - "Whitelist specific origins"
      - "Validate Origin header"

  client_side_security:
    rule: "Do not rely on client-side security"
    description: |
      All security checks must be enforced server-side.
    prohibited:
      - "Hiding admin buttons = authorization"
      - "Client-side input validation only"
      - "Storing secrets in localStorage"
      - "Security decisions in JavaScript"

  unvalidated_file_uploads:
    rule: "Do not accept files without validation"
    requirements:
      - "Validate file type (magic bytes, not extension)"
      - "Limit file size"
      - "Scan for malware"
      - "Store outside web root"
      - "Generate new filenames"

# =============================================================================
# VERIFICATION CHECKLIST
# =============================================================================
verification:
  pre_commit:
    - "No secrets in diff"
    - "Input validation present"
    - "Auth checks on new endpoints"
    - "Error handling doesn't leak info"

  pre_release:
    - "npm audit clean"
    - "OWASP top 10 review"
    - "Security headers configured"
    - "Penetration testing completed"
